name: Cpp_CI
on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  BINARY_NAME: ave_analysis
  PROJECT_PATH: CppSrc

permissions:
  contents: write
  pages: write      # Nécessaire pour déployer la doc
  id-token: write   # Nécessaire pour GitHub Pages

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.PROJECT_PATH }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake cppcheck clang-format \
          pkg-config libfftw3-dev

      - name: Check Formatting (Clang-Format)
        run: |
          find src include -name '*.cpp' -o -name '*.h' | xargs clang-format -n -Werror || echo "Run clang-format -i to fix"

      - name: Static Analysis (Cppcheck)
        run: |
          cppcheck --enable=warning,performance,portability --inconclusive --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=useStlAlgorithm \
          --suppress=unusedFunction \
          --suppress=functionStatic \
          --suppress=functionConst \
          -I include src/

  docs:
    name: Build Documentation
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen

      - name: Install MkDocs & MkDoxy
        run: |
          # mkdoxy s'occupe de l'extraction des docstrings C++ en Markdown
          pip install mkdocs-material mkdoxy

      - name: Setup Docs Structure
        run: |
          # 1. On force la création du dossier docs (s'il existe déjà, -p ne fait rien)
          mkdir -p docs
          
          # 2. Si index.md n'existe pas, on le crée à partir du README ou d'un texte par défaut
          if [ ! -f docs/index.md ]; then
            echo "index.md missing, creating from README..."
            if [ -f README.md ]; then
              cp README.md docs/index.md
            else
              echo "# AuraSync Documentation" > docs/index.md
            fi
          fi
          
          # 3. Si mkdocs.yml n'existe pas, on le crée
          if [ ! -f mkdocs.yml ]; then
            echo "Creating temporary mkdocs.yml..."
            echo "site_name: AuraSync Documentation" > mkdocs.yml
            echo "theme:" >> mkdocs.yml
            echo "  name: material" >> mkdocs.yml
            # Pas besoin de définir 'nav' strictement, mkdocs le devine si le dossier docs existe
          fi

      - name: Build Site
        run: mkdocs build

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site'

  # Déploiement de la doc uniquement sur main/master
  deploy-docs:
    name: Deploy Docs to Pages
    needs: docs
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # -----------------------------------------------------------
  # JOB TESTS (Inchangé)
  # -----------------------------------------------------------
  test:
    name: Test on ${{ matrix.os }}
    needs: quality
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    defaults:
      run:
        working-directory: ${{ env.PROJECT_PATH }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libfftw3-dev

      - name: Install macOS Dependencies
        if: runner.os == 'macOS'
        run: brew install fftw pkg-config

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgJsonGlob: 'CppSrc/vcpkg.json'

      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

      - name: Configure CMake (Non-Windows)
        if: runner.os != 'Windows'
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Run Tests
        working-directory: ${{ env.PROJECT_PATH }}/build
        run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure

  deploy:
    name: Deploy Release
    needs: test
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: ${{ env.PROJECT_PATH }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            suffix: linux
          - os: windows-latest
            suffix: windows.exe
          - os: macos-latest
            suffix: macos

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux Deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libfftw3-dev

      - name: Install macOS Deps
        if: runner.os == 'macOS'
        run: brew install fftw pkg-config

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgJsonGlob: 'CppSrc/vcpkg.json'

      - name: Build Release (Windows)
        if: runner.os == 'Windows'
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
          cmake --build build --config Release

      - name: Build Release (Non-Windows)
        if: runner.os != 'Windows'
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Prepare Artifact
        shell: bash
        run: |
          BIN_PATH="build/bin"
          if [ "${{ runner.os }}" == "Windows" ]; then
             BIN_PATH="build/bin/Release"
          fi
          cp "$BIN_PATH/${{ env.BINARY_NAME }}"* "${{ env.BINARY_NAME }}-${{ matrix.suffix }}"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.PROJECT_PATH }}/${{ env.BINARY_NAME }}-${{ matrix.suffix }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}