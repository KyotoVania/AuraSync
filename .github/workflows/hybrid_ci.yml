name: Hybrid Rust/C++ CI/CD

on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]

env:
  CARGO_TERM_COLOR: always
  # Names of the binaries
  RUST_BIN_NAME: rust-visualizer
  CPP_BIN_NAME: ave_analysis
  BUILD_TYPE: Release

permissions:
  contents: write
  checks: write
  issues: write
  pages: write
  id-token: write

jobs:
  # Job 1: Quality Assurance (Linting & Security for BOTH languages)
  quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Install System Dependencies (Merged list for Rust Audio & C++ FFTW)
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake cppcheck clang-format \
            libasound2-dev libudev-dev pkg-config \
            libx11-dev libxcursor-dev libxi-dev libxrandr-dev libwayland-dev libxkbcommon-dev \
            libfftw3-dev

      # --- Rust Checks ---
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust Security Audit
        uses: actions-rs/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rust Formatting
        run: cargo fmt -- --check

      - name: Rust Clippy
        run: cargo clippy -- -D warnings

      # --- C++ Checks ---
      - name: C++ Formatting (Clang-Format)
        # Checks src/ directory assuming C++ files are there
        run: |
          find src -name '*.cpp' -o -name '*.h' | xargs clang-format -n -Werror || echo "Run clang-format -i locally"

      - name: C++ Static Analysis (Cppcheck)
        run: |
          cppcheck --enable=all --inconclusive --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          -I include src/

  # Job 2: Hybrid Test Suite
  test:
    name: Test (${{ matrix.os }})
    needs: quality
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Environment Setup ---

      # Linux Deps
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          libasound2-dev libudev-dev libx11-dev libwayland-dev libxkbcommon-dev \
          pkg-config libfftw3-dev

      # macOS Deps
      - name: Install macOS Dependencies
        if: runner.os == 'macOS'
        run: brew install fftw pkg-config

      # Windows Deps (Chocolatey/Vcpkg would go here if not using local DLLs)

      # --- Rust Testing ---
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2

      - name: Run Rust Tests
        run: cargo test --verbose

      # --- C++ Testing ---
      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build C++ Tests
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Run C++ Tests
        working-directory: build
        run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure

  # Job 3: Documentation (RustDoc + Doxygen)
  documentation:
    name: Build & Deploy Docs
    needs: quality
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev doxygen graphviz

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Generate Rust Docs
      - name: Generate Rust Docs
        run: cargo doc --no-deps --release

      # Generate C++ Docs (Expects Doxyfile)
      # We create a dummy Doxyfile if one doesn't exist for the sake of the script
      - name: Generate C++ Docs
        run: |
          if [ -f Doxyfile ]; then
             doxygen Doxyfile
          else
             echo "No Doxyfile found, skipping C++ doc generation"
             mkdir -p html # create empty dir to prevent failure
          fi

      # Merge Docs: We move Rust docs to 'public/rust' and C++ to 'public/cpp'
      - name: Prepare Site Artifact
        run: |
          mkdir -p public
          mv target/doc public/rust
          mv html public/cpp || true
          
          # Create a landing page
          echo '<html><body><h1>Project Documentation</h1><ul><li><a href="rust/index.html">Rust Visualizer Docs</a></li><li><a href="cpp/index.html">C++ Analysis Docs</a></li></ul></body></html>' > public/index.html

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Job 4: Release (Binaries for both)
  deploy:
    name: Deploy Release
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            suffix: linux
          - os: windows-latest
            suffix: windows.exe
          - os: macos-latest
            suffix: macos

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Setup ---
      - name: Install Linux Deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev pkg-config libfftw3-dev

      - name: Install macOS Deps
        if: runner.os == 'macOS'
        run: brew install fftw

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # --- Build Rust ---
      - name: Build Rust Release
        run: cargo build --release --verbose

      # --- Build C++ ---
      - name: Build C++ Release
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      # --- Package ---
      - name: Prepare Artifacts
        shell: bash
        run: |
          mkdir release_assets
          
          # Fix: C++ binary is in build/bin/ (Linux/Mac) or build/bin/Release/ (Windows)
          # We check locations dynamically to be safe
          
          if [ "${{ runner.os }}" == "Windows" ]; then
            # Windows puts executables in subfolders named after config (Release/Debug)
            cp build/bin/Release/${{ env.CPP_BIN_NAME }}.exe release_assets/${{ env.CPP_BIN_NAME }}-${{ matrix.suffix }}
            cp target/release/${{ env.RUST_BIN_NAME }}.exe release_assets/${{ env.RUST_BIN_NAME }}-${{ matrix.suffix }}
          else
            # Linux/Mac usually respect CMAKE_RUNTIME_OUTPUT_DIRECTORY directly
            cp build/bin/${{ env.CPP_BIN_NAME }} release_assets/${{ env.CPP_BIN_NAME }}-${{ matrix.suffix }}
            cp target/release/${{ env.RUST_BIN_NAME }} release_assets/${{ env.RUST_BIN_NAME }}-${{ matrix.suffix }}
          fi

      - name: Create Release & Upload
        uses: softprops/action-gh-release@v1
        with:
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}